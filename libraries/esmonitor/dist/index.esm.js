var ft=Object.defineProperty;var q=(s,t)=>{for(var e in t)ft(s,e,{get:t[e],enumerable:!0})};var pt="[object Module]",O=s=>!!(s&&(!!Object.keys(s).reduce((e,o)=>{let n=Object.getOwnPropertyDescriptor(s,o),r=n&&n.get&&!n.set?1:0;return e+r},0)||Object.prototype.toString.call(s)===pt));var X=(s,t)=>{if(s&&typeof s=="object"&&t&&typeof t=="object"){let e=JSON.stringify(s),o=JSON.stringify(t);return e===o}else return s===t},I=(s,t)=>Promise.all(Object.getOwnPropertySymbols(s).map(e=>t(e,s[e]))),d=(s,t)=>{let e=t.path[s];if(!e)throw new Error("Invalid Path Type");return e.filter(n=>typeof n=="string").join(t.keySeparator)},E=(s,t)=>{let e=s;return typeof s=="string"?e=s.split(t.keySeparator):typeof s=="symbol"&&(e=[s]),{id:e[0],path:e.slice(1)}},_=(s,t,e,o,n=!0)=>{if(s instanceof Function&&(o&&typeof o=="object"&&typeof o.then=="function"?o.then(r=>s(t,e,r)):s(t,e,o)),n&&globalThis.ESMonitorState){let r=globalThis.ESMonitorState.callback;globalThis.ESMonitorState.state[t]={output:o,value:e},_(r,t,e,o,!1)}};var ut=60,F=class{constructor(t,e){this.listeners={};this.setOptions=(t={})=>{for(let e in t)this[e]=t[e]};this.add=t=>{let e=t.sub;return this.listeners[e]=t,this.start(),!0};this.get=t=>this.listeners[t];this.remove=t=>{delete this.listeners[t],Object.keys(this.listeners).length||this.stop()};this.poll=t=>{I(t,(e,o)=>{let{callback:n,current:r,history:i}=o;o.path.resolved||(o.path.resolved=d("output",o)),X(r,i)||(_(n,o.path.resolved,{},r),typeof r=="object"?Array.isArray(r)?i=[...r]:i={...r}:t[e].history=r)})};this.start=(t=this.listeners)=>{this.sps?this.#t||(console.warn("[escode]: Starting Polling!"),this.#t=setInterval(()=>this.poll(t),1e3/this.sps)):this.sps=ut};this.stop=()=>{this.#t&&(console.warn("[escode]: Stopped Polling!"),clearInterval(this.#t),this.#t=void 0)};t&&(this.listeners=t),e&&(this.sps=e)}#t;#e;get sps(){return this.#e}set sps(t){this.#e=t;let e=this.listeners;Object.keys(e).length&&(this.stop(),this.start())}};var L={};q(L,{functionExecution:()=>K,functions:()=>it,getProxyFunction:()=>W,info:()=>B,register:()=>rt,set:()=>J,setterExecution:()=>U,setters:()=>H});globalThis.ESMonitorState={state:{},callback:void 0,info:{}};var Z=globalThis.ESMonitorState;var ht=async(s,t)=>{let e=globalThis.performance.now(),o=await s(...t),n=globalThis.performance.now();return{output:o,value:n-e}},V={performance:ht},tt=(s,t,e)=>{let o={value:{},output:void 0},n={...Z.info,...e};for(let r in n)if(n[r]&&V[r]){let i=s;s=async(...c)=>{let a=await V[r](i,c);return o.value[r]=a.value,a.output}}return o.output=s(...t),o};var S=Symbol("isProxy"),v=Symbol("fromInspectable"),Ft=Symbol("fromInspectableHandler");var k=".",mt="default";var bt={isGraphScript:"__",properties:"__props",default:mt,parent:"__parent",promise:"__childresolved",component:"__component",proxy:"__proxy"},Lt={...bt,start:"__onconnected",stop:"__ondisconnected",connected:"__connected",resolved:"__resolved",started:"__started",element:"__element",webcomponents:"__define",attributes:"__attributes",listeners:{value:"__listeners",branch:"__branch",bind:"__bind",trigger:"__trigger",format:"__format"},trigger:"__trigger",compose:"__compose",apply:"__apply",uri:"src",reference:"ref",childPosition:"__childposition",attribute:"escomponent",options:"__options",source:"__source",path:"__path",animate:"__animate",states:"__states",editor:"__editor",original:"__original",resize:"__onresize"};var et=(s,t)=>s in t,dt=(s,t,e)=>{let o=t[s[0]];if(o){let n=o[s.slice(1).join(e)];if(n)return n}},T=(s,t,e={})=>{let o=e.fallbacks??[],n=e.keySeparator??k;if(e.shortcuts){let a=dt(t,e.shortcuts,n);if(a)return e.output==="info"?{value:a,exists:!0,shortcut:!0}:a}typeof t=="string"?t=t.split(n).flat():typeof t=="symbol"&&(t=[t]);let r;t=[...t],t=t.map(a=>typeof a=="string"?a.split(n):a).flat();let i=s,c=[i];for(let a=0;a<t.length;a++)if(i){let l=t[a];r=et(l,i),r?i=i[l]:(i=void 0,r=!0),c.push(i)}return e.output==="info"?{value:i,exists:r,parent:c[c.length-2]}:i},C=(s,t,e,o={})=>{let n=o?.create??!1,r=o?.keySeparator??k;typeof s=="string"?s=s.split(r):typeof s=="symbol"&&(s=[s]),s=[...s];let i=[...s],c=i.pop();for(let a=0;a<i.length;a++){let l=i[a],p=et(l,e);n&&!p&&(e[l]={},p=!0),p&&(e=e[l])}return e[c]=t,!0};var D={};q(D,{functions:()=>St,objects:()=>$});function gt(s,t){let e=this,o=this.target;if(!this.parent){let n=o[s];try{Object.defineProperty(o,s,{get:()=>n,set:function(r){n=r,e.proxy[s]={[S]:this[S],[v]:!0,value:r}},enumerable:!0,configurable:!0})}catch{console.error(`Could not reassign ${s} to a top-level setter...`)}}t&&this.newKeys.add(s),this.create(s,o,void 0,!0)}var R=gt;var St=function(){let s=this;return{apply:async function(t,e,o){try{let n=t;o[0]?.[v]&&(n=o[0].value,o=o.slice(1));let i=s.listeners.functions,c=s.path.join(s.options.keySeparator),a=i?i[c]:void 0,l,p={};a?(p=K(e,a,n,o),l=p.output):(l=n.apply(e,o),p=s?.state?.[c]?.value??{});let u=s.options.callback;return _(u,c,p,l),l}catch(n){console.warn("Function failed:",n,s.path)}}}},$=function(){let s=this;return{get(t,e,o){return e===S?!0:Reflect.get(t,e,o)},set(t,e,o,n){if(e===S)return!0;let r=[...s.path,e].join(s.options.keySeparator),i=o?.[S],c=o?.[v];c&&(o=o.value);let a=s.listeners.setters,l=Object.getOwnPropertyDescriptor(t,e);if(l&&!l.get&&!l.set&&typeof s.options.globalCallback=="function"){let f=s.path[0];R.call(s,e,!0),J("setters",r,o,s.options.globalCallback,{[f]:s.root},s.listeners,s.options)}if(o||typeof o=="function"){let f=s.create(e,t,o);f&&(o=f)}let u=!i;if(a&&u&&!s.newKeys.has(e)){let f=a[r];f&&U(f,o)}let b=s.options.callback,y=s?.state?.[r]?.value??{};return _(b,r,y,o),c||!u?!0:Reflect.set(t,e,o,n)}}};var st=typeof process=="object";var Pt=(s,t,e)=>{try{e===void 0&&(e=s[t])}catch(l){return l}if(s[t]&&s[t][S])return!1;let n=typeof e,r=n==="object",i=n=="function";if(!e||!(r||i)||!st&&e instanceof Element||e instanceof EventTarget)return!1;let a=r&&O(e);if(i)return!0;{let l=Object.getOwnPropertyDescriptor(s,t);if(l&&(l.value&&l.writable||l.set)){if(!a)return!0}else if(!s.hasOwnProperty(t))return!0}return!1},j=class{constructor(t={},e={},o,n){this.path=[];this.listeners={};this.newKeys=new Set;this.state={};this.set=(t,e,o)=>{this.state[t]={output:o,value:e},C(t,o,this.proxy,{create:!0})};this.check=Pt;this.create=(t,e,o,n=!1)=>{let r=this.check(e,t,o);if(o===void 0&&(o=e[t]),r&&!(r instanceof Error))return e[t]=new j(o,this.options,t,this),e[t];if(n)try{this.proxy[t]=o??e[t]}catch(i){let c=O(e),a=[...this.path,t];console.error(`Could not set value (${a.join(this.options.keySeparator)})${c?" because the parent is an ESM.":""}`,c?"":i)}};if(e.pathFormat||(e.pathFormat="relative"),e.keySeparator||(e.keySeparator=k),t.__proxy)this.proxy=t.__proxy;else if(t[S])this.proxy=t;else{this.target=t,this.options=e,this.parent=n,this.parent?(this.root=this.parent.root,this.path=[...this.parent.path],this.state=this.parent.state??{}):this.root=t,o&&this.path.push(o),this.options.listeners&&(this.listeners=this.options.listeners),this.options.path&&(this.options.path instanceof Function?this.path=this.options.path(this.path):Array.isArray(this.options.path)?this.path=this.options.path:console.log("Invalid path",this.options.path)),this.path&&(this.path=this.path.filter(c=>typeof c=="string")),this.options.keySeparator||(this.options.keySeparator=k);let r=this.options.type;r!="object"&&(r=typeof t=="function"?"function":"object");let i=D[`${r}s`].call(this);r==="function"&&(i={...i,...$.call(this)}),this.proxy=new Proxy(t,i),Object.defineProperty(t,"__proxy",{value:this.proxy,enumerable:!1}),Object.defineProperty(t,"__esInspectable",{value:this,enumerable:!1});for(let c in t)R.call(this,c)}return this.proxy}};var N=(s,t,e,o)=>{let n=o.reference,r=Array.isArray(s)?s[0]:typeof s=="string"?s.split(e.keySeparator)[0]:s,i=o.hasOwnProperty("static")?!o.static:!1;i&&!globalThis.Proxy&&(i=!1,console.warn("Falling back to using function interception and setters...")),i&&(t=new j(t,{pathFormat:e.pathFormat,keySeparator:e.keySeparator,listeners:o.listeners,path:a=>a.filter(l=>!e.fallbacks||!e.fallbacks.includes(l))},r));let c={keySeparator:e.keySeparator,...o};return C(s,t,n,c),t};var B=(s,t,e,o,n,r,i,c={})=>{typeof e=="string"&&(e=e.split(i.keySeparator));let a=e.join(i.keySeparator),l=n,p=c.ref,u=c.path,b=g=>T(p??n,g,{keySeparator:i.keySeparator,fallbacks:i.fallbacks}),y=(g,A)=>{N(g,A,i,{reference:p??n,listeners:r})},f=i.onUpdate,h={};f&&typeof f=="object"&&f.callback instanceof Function&&(h=f.info??{},f=f.callback);let m=[s,...e],P={absolute:m,relative:a.split(i.keySeparator),parent:m.slice(0,-1)};P.output=P[i.pathFormat];let x={id:s,path:P,keySeparator:i.keySeparator,infoToOutput:h,callback:(...g)=>{let A=t(...g);return f instanceof Function&&f(...g),A},get current(){return b(u??x.path.absolute)},set current(g){y(u??x.path.absolute,g)},get parent(){return b(u?u?.slice(0,-1):x.path.parent)},get reference(){return l[s]},set reference(g){l[s]=g},original:o,history:typeof o=="object"?Object.assign({},o):o,sub:Symbol("subscription"),last:e.slice(-1)[0]};return x},ot=(s,t,e)=>{if(e){let o=Math.random();e.symbol[t]={name:s,id:o},e.name[s]||(e.name[s]={}),e.name[s][o]=t}},rt=(s,t,e)=>{let o=d("absolute",s);return t[o]||(t[o]={}),t[o][s.sub]=s,ot(o,s.sub,e),!0},z={functions:it,setters:H},J=(s,t,e,o,n,r,i)=>{let{id:c,path:a}=E(t,i),l=B(c,o,a,e,n,z,i);if(z[s])z[s](l,r,r.lookup);else{let p=d("absolute",l);r[s][p][l.sub]=l,r.lookup&&ot(p,l.sub,r.lookup)}},xt=(s,t)=>t[d("absolute",s)],nt=(s,t,e,o)=>{let n=!!xt(s,t);if(!n){let r=s.parent,i=r?.[s.last];n=e(i,r)}return rt(s,t,o)},U=(s,t)=>I(s,(e,o)=>{let n=d("output",o);_(o.callback,n,{},t)});function H(s,t,e){let o=this;return nt(s,t.setters,(n,r)=>{let i=n;if(!!r&&!r[S]){let c=!0;try{delete r[s.last]}catch{console.error("Unable to redeclare setters. May already be a dynamic object..."),c=!1}if(c){let a=s.last.slice(0,2)==="__"||s.last==="default";try{Object.defineProperty(r,s.last,{get:()=>i,set:async l=>{let p=typeof i=="function";if(i=l,p)i=W.call(o,s,t,i);else{let u=Object.assign({},t.setters[d("absolute",s)]);U(u,l)}},enumerable:!a,configurable:!0})}catch(l){throw l}}}},e)}function W(s,t,e){return function(...o){let n=t.functions[d("absolute",s)];return K(this,n,e??s.original,o).output}}var K=(s,t,e,o)=>{t=Object.assign({},t);let n=Object.getOwnPropertySymbols(t),r=t[n[0]]??{},i=tt((...c)=>e.call(s,...c),o,r.infoToOutput);return I(t,(c,a)=>{let l=d("output",a);_(a.callback,l,i.value,i.output)}),i};function it(s,t,e){return nt(s,t.functions,(o,n)=>{if(!n[S])return n[s.last]=W.call(this,s,t),H(s,t,e)},e)}var at=(s,t,e)=>{let o=e.accumulator;o||(o=e.accumulator={});let n=e.ignore||[],r=e.path||[],i=e.condition||!0,c=[],a=[],l=(p,u={},b)=>{for(let y in p){if(n.includes(y))continue;let f=p[y],h=[...b.path,y],m={typeof:typeof f,name:f?.constructor?.name,simple:!0,object:f&&typeof f=="object",path:h};if(m.object){let P=m.name;if(O(f)||P==="Object"||P==="Array"){m.simple=!0;let x=c.indexOf(f);if(x!==-1)u[y]=a[x];else{c.push(f);let g=i instanceof Function?i(y,f,m):i;m.pass=g,u[y]=t(y,f,m),g&&(a.push(u[y]),u[y]=l(f,u[y],{...b,path:h}))}}else m.simple=!1,u[y]=t(y,f,m)}else u[y]=t(y,f,m)}return u};return l(s,o,{path:r})};var lt=()=>({symbol:{},name:{}}),_t=typeof process=="object",M=class{constructor(t={}){this.poller=new F;this.options={pathFormat:"relative",keySeparator:k};this.listeners={polling:this.poller.listeners,functions:{},setters:{},lookup:lt()};this.references={};this.get=(t,e,o=this.references)=>T(o,t,{keySeparator:this.options.keySeparator,fallbacks:this.options.fallbacks,output:e});this.set=(t,e,o={})=>{let n={...o};return n.reference||(n.reference=this.references),n.listeners||(n.listeners=this.listeners),N(t,e,this.options,n)};this.on=(t,e)=>{let o=E(t,this.options);return this.listen(o.id,e,o.path)};this.getInfo=(t,e,o,n)=>{let r=B(t,e,o,n,this.references,this.listeners,this.options),i=Math.random(),c=this.listeners.lookup,a=d("absolute",r);return c.symbol[r.sub]={name:a,id:i},c.name[a]||(c.name[a]={}),c.name[a][i]=r.sub,r};this.listen=(t,e,o=[],n={})=>{typeof o=="string"?o=o.split(this.options.keySeparator):typeof o=="symbol"&&(o=[o]);let r=o,i=this.get(t);if(!i){console.error("Reference does not exist.",t);return}n.poll||(n.poll=O(i)),n.seen||(n.seen=[]);let c=n,a=[t,...r],l=this.get(a),p=(h,m=!1)=>!(h&&typeof h=="object")||!_t&&h instanceof Element?!1:m?!0:!Array.isArray(h),u={},b=!1;p(l,!0)&&(l.__esInspectable&&(l.__esInspectable.options.globalCallback=e),at(l,(h,m,P)=>{if(!P.pass){let w=[...r,...P.path],x=this.listen(t,e,w,c);Object.assign(u,x)}},{condition:(h,m)=>p(m)}),b=!0);let f;try{if(f=this.getInfo(t,e,r,l),f&&!b)if(c.poll)b=this.poller.add(f);else{let h="setters";typeof l=="function"&&(h="functions"),b=this.add(h,f)}}catch(h){console.error("Fallback to polling:",o,h),b=this.poller.add(f)}if(b){if(u[d("absolute",f)]=f.sub,this.options.onInit instanceof Function){let h={};for(let m in f.infoToOutput)h[m]=void 0;this.options.onInit(d("output",f),h)}return u}else{console.error("Failed to subscribe to:",o);return}};this.add=(t,e)=>L[t]?L[t](e,this.listeners,this.listeners.lookup):(this.listeners[t][d("absolute",e)][e.sub]=e,!0);this.remove=t=>{t||(t={...this.listeners.functions,...this.listeners.setters,...this.listeners.polling}),typeof t!="object"&&(t={sub:t});for(let e in t){let o=t[e],n=r=>{this.unsubscribe(r)===!1&&console.warn(`Subscription for ${e} does not exist.`,r)};typeof o!="symbol"?I(o,n):n(o)}return!0};this.unsubscribe=t=>{let e=this.listeners.lookup.symbol[t],o=e.name,n=this.poller.get(t),r=this.listeners.functions[o],i=r?.[t],c=this.listeners.setters[o],a=c?.[t];if(n)this.poller.remove(t);else if(i)delete r[t],Object.getOwnPropertySymbols(r).length||(Object.defineProperty(i.parent,i.last,{value:i.original,writable:!0}),delete this.listeners.functions[o]);else if(a){if(delete c[t],!Object.getOwnPropertySymbols(c).length){let p=a.parent;if(p){let u=a.last,b=p[u];Object.defineProperty(p,u,{value:b,writable:!0})}delete this.listeners.setters[o]}}else return!1;delete this.listeners.lookup.symbol[t];let l=this.listeners.lookup.name[e.name];delete l[e.id],Object.getOwnPropertyNames(l).length||delete this.listeners.lookup.name[e.name]};Object.defineProperty(this.listeners,"lookup",{value:lt(),enumerable:!1,configurable:!1}),Object.assign(this.options,t),this.poller.setOptions(t.polling)}};var oe=M;export{oe as default};
//# sourceMappingURL=index.esm.js.map
